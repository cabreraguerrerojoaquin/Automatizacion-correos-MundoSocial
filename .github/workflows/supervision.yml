name: Control Autom치tico de Entregas

on:
  schedule:
    # 1. VERIFICACI칍N RUTINARIA: Se ejecuta cada 30 minutos
    # Busca archivos nuevos en la carpeta Inbox
    - cron: '*/30 * * * *'
    
    # 2. REPORTE SEMANAL: Se ejecuta a las 05:00 UTC del Domingo
    # (Esto equivale exactamente a las 00:00 del Domingo en Per칰 / Medianoche del S치bado)
    - cron: '0 5 * * 0'

  # Permite ejecutar manualmente el flujo desde la pesta침a "Actions" de GitHub para pruebas
  workflow_dispatch:

jobs:
  ejecutar_bot:
    runs-on: ubuntu-latest

    steps:
      # Paso 1: Descargar tu c칩digo (auto_drive.py) al entorno virtual
      - name: Descargar c칩digo del repositorio
        uses: actions/checkout@v3

      # Paso 2: Instalar Python
      - name: Configurar Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # Paso 3: Instalar las dependencias que usa tu script
      - name: Instalar librer칤as necesarias
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth gspread oauth2client

      # Paso 4: Ejecutar la l칩gica principal
      - name: Ejecutar Script (Decidir si es Verificaci칩n o Reporte)
        env:
          # Mapeo de tus Secrets de GitHub a las variables de entorno que lee Python
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASS: ${{ secrets.GMAIL_PASS }}
          DRIVE_INBOX_ID: ${{ secrets.DRIVE_INBOX_ID }}
          DRIVE_PROCESSED_ID: ${{ secrets.DRIVE_PROCESSED_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
        run: |
          # Obtenemos la fecha y hora actual del servidor (siempre es UTC)
          # %u = D칤a de la semana (1=Lunes ... 7=Domingo)
          # %H = Hora actual formato 24h (00..23)
          DAY_OF_WEEK=$(date +%u)
          HOUR=$(date +%H)
          
          echo "游 Diagn칩stico de hora UTC: $HOUR:00 - D칤a de semana: $DAY_OF_WEEK"

          # L칍GICA DE DECISI칍N:
          # Si es Domingo (7) Y son las 05:00 AM UTC (Medianoche Per칰), ejecutamos reporte.
          # Nota: Usamos -eq 05 (o 5) para capturar la hora del cron.
          if [ "$DAY_OF_WEEK" -eq 7 ] && [ "$HOUR" -eq 05 ]; then
             echo "游늱 Es el horario del Reporte Semanal. Ejecutando modo reporte..."
             python auto_drive.py --modo reporte
          else
             echo "游댌 Es horario de rutina. Buscando archivos nuevos..."
             python auto_drive.py --modo verificar
          fi
